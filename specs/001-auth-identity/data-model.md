# Data Model: Authentication & Identity for Todo Full-Stack Web Application

## Primary Entities

### 1. User
Represents an authenticated user with unique identifier and contact information.

**Fields:**
- `id` (string): Unique user identifier generated by Better Auth
- `email` (string): User's email address, used for authentication
- `name` (string, optional): User's display name
- `created_at` (datetime): Account creation timestamp
- `updated_at` (datetime): Last account update timestamp

**Relationships:**
- One-to-many with Tasks (user has many tasks)
- One-to-many with Sessions (user has many sessions - though not storing server-side)

**Validation Rules:**
- Email must be valid email format
- Email must be unique across all users
- ID must be unique and non-empty

**State Transitions:**
- `registered` → `active` (upon successful verification - if applicable)
- `active` → `suspended` (administrative action - not implemented per spec)

### 2. JWT (JSON Web Token)
Secure, signed token containing user identity and expiration claims, used for backend authentication.

**Structure:**
- Header: Algorithm (HS256) and Token Type (JWT)
- Payload: Claims including user identity and expiration
- Signature: Created using BETTER_AUTH_SECRET

**Claims:**
- `iss` (issuer): Identifies the principal that issued the JWT
- `sub` (subject): Identifies the principal that is the subject of the JWT (user_id)
- `aud` (audience): Identifies the recipients that the JWT is intended for
- `exp` (expiration time): Defines the expiration time on or after which the JWT must not be accepted
- `iat` (issued at time): Identifies the time at which the JWT was issued
- `jti` (JWT ID): Provides a unique identifier for the JWT
- `user_email` (custom claim): User's email address
- `user_id` (custom claim): Unique user identifier

**Validation Rules:**
- Token signature must match BETTER_AUTH_SECRET
- Token must not be expired (exp > current time)
- Token must not be malformed
- Required claims must be present

### 3. Shared Secret
Cryptographic key used to sign and verify authentication tokens, stored securely in environment variables.

**Properties:**
- Value: Randomly generated string (recommended 32+ characters)
- Storage: Environment variable (BETTER_AUTH_SECRET)
- Format: Base64 encoded or alphanumeric string
- Rotation: Should be rotated periodically in production

**Validation Rules:**
- Must be at least 32 characters long
- Should contain mixed case, numbers, and special characters
- Must not be hardcoded in source code
- Must match between frontend (Better Auth) and backend (JWT verification)

## Derived Models

### 4. CurrentUser (Runtime Model)
Represents the authenticated user identity extracted from JWT for use in backend operations.

**Fields:**
- `user_id` (string): Unique identifier of the authenticated user
- `email` (string): Email address of the authenticated user
- `is_authenticated` (boolean): Flag indicating authentication status

**Usage Context:**
- Created during JWT verification process
- Passed to route handlers as dependency
- Used for multi-tenant data isolation

## Relationships and Constraints

### Multi-Tenant Isolation Constraint
- All user-specific data access must be filtered by the authenticated user's ID
- Backend routes must verify that user_id in URL matches user_id in JWT
- Cross-user data access is prohibited

### Authentication Flow Relationship
```
User Registration/Login → JWT Generation → API Request → JWT Verification → CurrentUser Extraction → Data Access
```

## Schema Evolution Considerations

### Future Extensions (Out of Scope for Current Spec)
- Refresh tokens (explicitly excluded per spec)
- Role-based access control (RBAC) (explicitly excluded per spec)
- Social login providers (explicitly excluded per spec)
- User profile extensions (out of scope per spec)

### Backward Compatibility
- JWT structure should maintain compatibility for token validation
- User model fields should remain stable for existing tokens
- Secret rotation strategy should maintain overlapping validity windows

## Validation and Constraints Summary

### Security Constraints
1. All API requests require valid JWT authentication
2. JWT verification must use BETTER_AUTH_SECRET
3. User identity must be extracted from JWT, not client-supplied values
4. No server-side session storage (stateless requirement)

### Data Integrity Constraints
1. User email uniqueness
2. User ID uniqueness
3. JWT signature validation
4. Token expiration enforcement

### Access Control Constraints
1. Multi-tenant isolation (users can only access own data)
2. User ID in URL must match JWT user ID
3. Unauthenticated requests receive HTTP 401
4. All user-specific routes require authentication